# Repository Guidelines

## 项目结构与模块组织
- 源码：`src/`（NestJS 模块化）
  - 入口：`src/main.ts`；根模块：`src/app.module.ts`
  - 业务模块：`users/`、`auth/`、`projects/`、`review/`、`ai/`、`gitlab/`、`common/`
- 数据模型：`prisma/schema.prisma`
- 测试：同目录 `*.spec.ts`（单元/集成）；E2E 在 `test/`
- 构建产物：`dist/`
- 配置与文档：`.env`（参考 `.env.example`）、`nest-cli.json`、`tsconfig*.json`、`Architecture-Overview.md`

## 构建、测试与本地开发
- 开发启动：`npm run start:dev`（热重载）
- 生产启动：`npm run build && npm run start:prod`
- 代码检查：`npm run lint`；格式化：`npm run format`
- 单元测试：`npm test`；覆盖率：`npm run test:cov`
- E2E 测试：`npm run test:e2e`
- 可选编排：`docker-compose up -d`（如需依赖服务）

## 代码风格与命名约定
- 语言：TypeScript（NestJS DI + 装饰器）
- Lint/Format：ESLint（`eslint.config.mjs`）+ Prettier（`.prettierrc`）
  - Prettier：`singleQuote: true`，`trailingComma: all`
- 缩进与命名：2 空格；类/装饰器 `PascalCase`，变量/函数 `camelCase`，文件小写连字符或语义后缀（如 `users.service.ts`、`auth.dto.ts`）
- 分层约定：Controller 只处理 I/O；业务逻辑置于 Service；数据访问经 `PrismaService`

## 测试规范
- 框架：Jest（`*.spec.ts`）；E2E 配置：`test/jest-e2e.json`
- 约束：新增/变更功能需配套单测；接口改动建议增加 E2E
- 命名示例：`users.controller.spec.ts`、`projects.service.spec.ts`
- 运行：`npm test` / `npm run test:cov` / `npm run test:e2e`

## 提交与 Pull Request
- 提交信息：建议遵循 Conventional Commits（如 `feat: ...`、`fix: ...`、`chore: ...`）
- PR 要求：
  - 清晰描述与变更清单；关联 Issue
  - 必要时附运行截图/日志与影响面、回滚方案
  - 通过 `lint` 与全部测试；无未格式化文件

## 安全与配置提示（重要）
- 环境变量：基于 `.env.example` 创建 `.env`；切勿提交真实密钥
- Prisma：修改 `schema.prisma` 后执行 `npx prisma generate`；本地迁移用 `npx prisma migrate dev`
- API 文档：新增接口请补充 `@nestjs/swagger` 注解与示例

## 代理/工具集成（可选）
- MCP：项目包含 `.mcp.json` 与 `.serena/`，可用于代码检索与自动化编辑
- 约定：保持模块边界清晰，自动化修改需通过测试与 Lint

## 🔥 关键安全和质量规则

### 1. 绝不擅自做主
- **只能**修改明确要求的内容
- **绝不**改动无关的代码、文件或功能
- 如果觉得其他地方需要改动，**先问**
- 改动任何未明确要求的内容都是**禁止行为**

### 2. 依赖管理是必须的
- 添加import时**必须**更新package.json/requirements.txt
- **绝不**添加import语句而不声明对应依赖
- 建议代码前**先确认**所有依赖都已正确声明

### 3. 占位符是大忌
- **绝不**使用"YOUR_API_KEY"、"TODO"或虚拟数据
- **总是**使用合适的变量引用或配置模式
- 需要真实值时，**明确询问**
- 使用环境变量或配置文件，不要硬编码

### 4. 区分问题和代码请求
- 用户**问问题**时，提供**答案** - 不要改代码
- 只有明确要求"改动"、"更新"、"修改"、"修复"时才修改代码
- **绝不**把问题当成代码变更请求

### 5. 不假设不猜测
- 信息缺失时，请**要求**澄清
- **绝不**猜测库版本、API格式或实现细节
- **绝不**假设用户需求或使用场景
- 明确说明需要什么信息才能继续

### 6. 安全不可妥协
- **绝不**把API密钥、密钥或凭据放在客户端代码
- **总是**实现正确的认证和授权
- **总是**使用环境变量存储敏感数据
- **总是**实现适当的输入验证和净化
- **绝不**创建没有适当安全措施的公开数据库表
- **总是**为数据库访问实现行级安全

### 7. 能力诚实
- **绝不**试图生成图片、音频或其他媒体
- 被问及没有的能力时，明确说明局限性
- **绝不**为不可能的功能创建虚假实现
- 建议使用合适的库/服务作为替代方案

### 8. 保持功能需求
- **绝不**为了"修复"错误而改变核心功能
- 遇到错误时，修复技术问题，不是需求
- 如果需求看起来有问题，请在更改之前**询问**
- 记录任何必要的需求澄清

### 9. 基于证据的回答
- 被问及某功能是否已实现时，**展示代码证据**
- 格式："查看代码：[文件名] (第X-Y行): [相关代码片段]"
- **绝不**猜测或假设实现状态
- 不确定时，**明说**并提供检查特定文件

### 10. 不要硬编码示例
- **绝不**把示例值硬编码为永久解决方案
- **总是**使用变量、参数或配置处理动态值
- 展示示例时，明确标记为示例，不是实现

### 11. 智能日志实现
- **自动**添加必要日志来理解核心应用行为
- 记录关键决策点、数据转换和系统状态变化
- **不要**过度记录（避免记录每个变量或琐碎操作）
- **不要**记录不足（确保关键流程可追踪）
- 专注于有助于理解的日志：发生了什么、为什么发生、用什么数据
- 使用适当的日志级别：ERROR用于失败、WARN用于问题、INFO用于关键事件、DEBUG用于详细流程

## ⚠️ 违规后果
违反任何这些规则都被视为**严重错误**，可能：
- 破坏生产应用
- 引入安全漏洞  
- 浪费大量开发时间
- 损害项目完整性

## 🛑 紧急停止协议
如果对请求的**任何**方面不确定：
1. **停止**代码生成
2. **询问**澄清
3. **等待**明确确认
4. 只有100%确定时才继续

记住：宁可询问澄清，也不要做可能搞砸一切的假设。