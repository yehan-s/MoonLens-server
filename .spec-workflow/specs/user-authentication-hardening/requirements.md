# User Authentication Hardening — Requirements

## 概述
- 目标：在现有“User Authentication API System”全部完成的基础上，进一步强化账户安全、可运维性与可观测性，降低攻防风险，提升企业级可用性。
- 范围：后端（NestJS + Prisma + Redis 可选）；邮件/第三方服务对接；RBAC/ABAC 持久化；2FA；会话与刷新策略优化；指标与审计增强。
- 非目标：前端 UI 具体实现、移动端 SDK、支付/计费。

## 术语
- 2FA：双因素认证（TOTP）
- RBAC：基于角色的访问控制
- ABAC：基于属性的访问控制（按资源/条件）
- ROTATION：刷新令牌轮换与重用检测

## 角色与干系人
- 最终用户（End User）：登录/重置/安全设置。
- 管理员（Admin）：角色/权限/安全策略配置、审计。
- 运维（Ops/Sec）：监控、指标、日志采集与告警。

## 假设与前置
- 已有用户与认证、审计、会话、限流、健康检查等基础能力。
- 可配置 SMTP 或邮件服务商（或日志代替）。
- 可选 Redis（速率、黑名单、队列）；MySQL 为主数据源。

## 用户故事（EARS）与验收
1) 作为用户，我可以开启/关闭 TOTP 双因素认证（2FA），以提升账户安全。
- 验收：
  - 启用流程：显示 secret 与二维码，验证 1 次码成功后方可开启
  - 登录含 2FA 的账户需额外提交 TOTP

2) 作为用户，我可以完成邮箱地址验证（Email Verification），以防止冒用。
- 验收：
  - 注册/更换邮箱后可发送验证邮件；点击一次性链接完成验证

3) 作为安全管理员，我可以持久化管理“角色/权限”，并为用户授予与回收。
- 验收：
  - 新增表：roles/permissions/role_permissions/user_roles
  - 后台接口：CRUD 与授予/撤销；权限缓存 60s；角色继承

4) 作为系统，我可以在刷新令牌轮换时检测“旧令牌重用（Reuse）”，并触发撤销与告警。
- 验收：
  - 任意旧 refresh token 被再次使用时，撤销相关会话与令牌，并记录审计

5) 作为系统，我可以限制单用户并发会话数量（如最多 5 个），超出时自动淘汰最旧会话。
- 验收：
  - 登录创建第 N+1 个会话时，关闭最早活跃会话

6) 作为系统，我可以在登录异常或阈值触发时启用验证码（Captcha）校验。
- 验收：
  - 配置阈值后，错误过多或风控命中要求提交验证码

7) 作为系统，我可以将安全事件输出到结构化日志，并暴露指标以便告警。
- 验收：
  - 审计字段统一（event/category/actor/target/details）；Prom 指标扩展

## 功能需求（FR）
- FR-H1：支持 TOTP 2FA 的启用/验证/关闭（备份码可选）。
- FR-H2：支持邮箱验证（注册/更换邮箱）。
- FR-H3：RBAC/权限持久化与管理接口（缓存 + 继承）。
- FR-H4：刷新令牌轮换与重用检测，违规自动撤销并审计。
- FR-H5：会话并发限制与淘汰策略；远程终止维持可用。
- FR-H6：Captcha 集成（可切换供应商/本地实现），按策略启用。
- FR-H7：审计与指标扩展（2FA/验证/刷新/会话/权限）。

## 非功能需求（NFR）
- NFR-H1：安全：令牌与密钥安全存储；密文合规；审计可追溯。
- NFR-H2：性能：新特性平均响应 < 200ms（不含外部邮件/验证码）；缓存命中率 > 95%。
- NFR-H3：可用性：失败回退（邮件/验证码不可用时，降级与重试策略）。
- NFR-H4：可观测性：Prom 指标 + 结构化日志覆盖核心路径；错误率与重试暴露。
- NFR-H5：可配置：策略/阈值/开关以环境变量或配置服务方式注入。

## 风险与缓解
- 邮件/验证码外部依赖：本地兜底（日志/Mock）、重试、断路器。
- 2FA 失效：提供恢复代码与人工找回流程（后续可实现）。
- 权限持久化迁移：灰度切换，配置开关切回内存策略。

---
