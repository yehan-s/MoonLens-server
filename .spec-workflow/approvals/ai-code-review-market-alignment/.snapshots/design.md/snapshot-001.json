{
  "id": "snapshot_1758867817844_p3tjtjv3u",
  "approvalId": "approval_1758867817834_0ahssbh93",
  "approvalTitle": "Design: ai-code-review-market-alignment",
  "version": 1,
  "timestamp": "2025-09-26T06:23:37.844Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# 设计文档：ai-code-review-market-alignment（后端）\n\n## 1. 技术概览\n- 框架/语言：NestJS 11 + TypeScript，Prisma（MySQL），BullMQ（Redis）\n- 模块边界与数据流：\n  1) GitLab Webhook → `gitlab/controllers/webhook.controller.ts` + `guards/webhook-signature.guard.ts`\n  2) 事件验证与标准化 → 入队 `queue.service.ts`（jobs: review:enqueue）\n  3) 消费者 `modules/queue/processors/analysis.processor.ts`：\n     - 拉取 MR diff（`gitlab/services/merge-request.service.ts`/`repository.service.ts`）\n     - 组装 Prompt → 调用 AI 服务（`ai/ai.service.ts`）\n     - 结果标准化（summary + comments[]）→ 幂等回写（`gitlab/services/mr-discussion.service.ts`）\n     - 记录 `Review` 与 `ReviewItem`（Prisma）\n  4) 历史查询 API：`review.controller.ts`（GET /api/reviews）\n  5) 配置 API：`ai.controller.ts` 或新增 `config.controller.ts`（POST /api/config）\n- 关键非功能：零持久化源码（仅 diff 片段临时内存）、令牌与密钥加密、日志脱敏、Prometheus 指标\n\n## 2. 数据契约\n### 2.1 AI 服务输出（标准化内部结构）\n```ts\nexport type ReviewLevel = 'issue' | 'suggestion' | 'note';\nexport interface ReviewComment {\n  file: string;            // 相对路径\n  line?: number;           // 新文件行号（可选）\n  oldLine?: number;        // 旧文件行号（可选）\n  level: ReviewLevel;      // 严重级别\n  category?: string;       // 性质：security/perf/readability/maintainability/…\n  ruleId?: string;         // 可选规则/来源标识\n  fingerprint: string;     // 去重指纹（file+line+hash(content)）\n  comment: string;         // 文本建议\n}\nexport interface ReviewResult {\n  summary: string;         // MR 摘要\n  comments: ReviewComment[];\n  provider?: string;       // openai/anthropic/…\n  model?: string;\n  costMs?: number;         // AI 调用耗时\n}\n```\n\n### 2.2 历史查询 API（对前端）\n- `GET /api/reviews?projectId=xxx&mrIid=yyy&page=1&pageSize=20&level=issue|suggestion|note&category=security`\n- 响应：\n```json\n{\n  \"items\": [\n    {\n      \"id\": \"rev_123\",\n      \"projectId\": \"p_1\",\n      \"mrIid\": 7,\n      \"createdAt\": \"2025-09-26T05:12:00Z\",\n      \"summary\": \"…\",\n      \"counts\": { \"issue\": 3, \"suggestion\": 5, \"note\": 2 },\n      \"provider\": \"openai\",\n      \"model\": \"gpt-4o-mini\"\n    }\n  ],\n  \"page\": 1,\n  \"pageSize\": 20,\n  \"total\": 1\n}\n```\n- `GET /api/reviews/{id}` 返回单次详情（含 comments）。\n\n### 2.3 配置 API（项目级）\n- `POST /api/config` 输入：\n```json\n{\n  \"projectId\": \"p_1\",\n  \"provider\": \"openai\",\n  \"model\": \"gpt-4o-mini\",\n  \"temperature\": 0.2,\n  \"maxComments\": 20,\n  \"dedupe\": true,\n  \"trigger\": { \"labels\": [\"ai-review\"], \"minChangedLines\": 5 }\n}\n```\n- 输出：保存后的配置 + 审计记录 id\n\n## 3. 去重与幂等\n- 指纹：`fingerprint = sha256(file + ':' + (line||oldLine||0) + ':' + stableHash(comment))`\n- 去重策略：\n  - 单次结果内：Set 去重\n  - 历史维度：近 N 天（可配）内若存在相同指纹且未修改代码区域，则跳过回写，仅记录“重复建议被抑制”计数\n- 幂等回写：在 MR 讨论中标记标识（如 `[ML-FP:<fingerprint>]`）以避免重复发布；更新策略为“存在则跳过/合并摘要”\n\n## 4. 触发与队列\n- 触发事件：MR Create/Update/Note（评论触发对话式占位）\n- 入队：`reviews` 队列（attempts=3, backoff=exponential 2x, max 2min）\n- 消费：`analysis.processor.ts` 读取 job（projectId, mrIid, gitlabConnectionId）→ 执行业务流\n- 死信：`dead-letter.processor.ts` 记录并告警（日志/Prom 指标）\n\n## 5. Provider 与 Aggregator 抽象\n- Provider：在 `ai.service.ts` 内通过策略路由选择 provider（openai/anthropic/azure/openai_compatible）；所有 provider 统一输出 `ReviewResult`\n- Aggregator（预留）：接口 `StaticAnalysisAggregator`：\n```ts\ninterface StaticAnalysisIssue { file: string; line?: number; ruleId: string; level: 'blocker'|'critical'|'major'|'minor'; message: string; source: 'sonar'|'codacy'; }\ninterface StaticAnalysisAggregator { fetch(projectId: string, mrIid: number): Promise<StaticAnalysisIssue[]> }\n```\n- 聚合策略：与 AI 结果并列呈现，不混淆；可在摘要中引用数量与分布\n\n## 6. 安全与合规\n- 不持久化源码（只处理 diff 片段于内存）\n- 令牌与密钥：`GITLAB_ENC_KEY` AES-GCM 加密；不入日志\n- Webhook：校验 `X-Gitlab-Token`，按项目 secret 优先\n- 日志脱敏：URL/Token/代码片段屏蔽\n\n## 7. 指标与可观测性\n- Prometheus 指标：\n  - `ml_ai_call_duration_ms` (histogram, labels: provider, model, status)\n  - `ml_review_write_comments_total` (counter, labels: level)\n  - `ml_queue_length`、`ml_job_failures_total`\n- 日志：结构化（winston），追踪 jobId、projectId、mrIid\n\n## 8. 失败与降级\n- Provider 超时/配额 → 回退次级 provider（可选）或标记部分失败\n- 评论回写失败 → 重试；仍失败则将结果仅保存在历史记录中\n- 阈值触发：超过 `maxComments` 时仅写摘要 + Top-N 评论\n\n## 9. 迁移与数据模型（Prisma）\n- 新增/校验实体（示意）：\n```prisma\nmodel Review { id String @id @default(uuid()) projectId String mrIid Int createdAt DateTime @default(now()) summary String? provider String? model String? items ReviewItem[] @@index([projectId, mrIid]) @@map(\"reviews\") }\nmodel ReviewItem { id String @id @default(uuid()) reviewId String review Review @relation(fields:[reviewId], references:[id]) file String line Int? oldLine Int? level String category String? ruleId String? fingerprint String @index comment String @@map(\"review_items\") }\n```\n\n## 10. 落地步骤\n- A. 新增/完善 Prisma 模型与迁移（确保最小侵入）\n- B. 在 `analysis.processor.ts` 补齐标准化、去重、回写逻辑\n- C. 在 `review.controller.ts` 实现查询（分页/过滤）\n- D. 在 `ai.controller.ts` 或新 `config.controller.ts` 提供项目级配置的读写接口\n- E. 完善 `gitlab/.../mr-discussion.service.ts` 幂等回写策略（指纹标记）\n- F. 指标埋点与错误处理（Prom/Winston）\n",
  "fileStats": {
    "size": 6151,
    "lines": 133,
    "lastModified": "2025-09-26T06:23:05.733Z"
  },
  "comments": []
}