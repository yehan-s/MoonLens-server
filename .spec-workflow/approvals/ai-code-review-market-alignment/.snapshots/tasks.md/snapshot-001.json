{
  "id": "snapshot_1758868576938_djmcqueti",
  "approvalId": "approval_1758868576925_5re2w6emo",
  "approvalTitle": "Tasks: ai-code-review-market-alignment",
  "version": 1,
  "timestamp": "2025-09-26T06:36:16.938Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# 任务清单：ai-code-review-market-alignment（后端）\n\n> 状态标记规范：\n> - [ ] 待办\n> - [-] 进行中（开始实现前先将该行改为 [-]）\n> - [x] 已完成（实现与自测完成后，将 [-] 改为 [x] 并附简述）\n\n## 任务 1：校验/补齐 Prisma 模型（Review/ReviewItem）\n- [ ] 文件：\n  - prisma/schema.prisma\n- 描述：如已存在 `Review`/`ReviewItem` 模型则核对字段与索引；若无则按设计文档添加模型与索引。\n- 成功标准：`npx prisma generate` 成功；`npx prisma db push` 同步无错误；生成的 Client 可在服务中导入使用。\n- 提示：最小侵入，保留现有表与命名；模型示例见设计文档 9 节。\n- _Prompt：\n  Implement the task for spec ai-code-review-market-alignment, first run spec-workflow-guide to get the workflow guide then implement the task:\n  Role: NestJS + Prisma 工程师\n  Task: 在 prisma/schema.prisma 中校验或新增 Review/ReviewItem 模型与索引\n  Restrictions: 不破坏现有表结构；若同名模型已存在需兼容字段；禁止删除历史字段\n  _Leverage: 现有 prisma/schema.prisma；设计文档 9 节；`npm run prisma:generate`\n  _Requirements: FR-5（历史查询），FR-2（内容保存），NFR-4（可扩展性）\n  Success: db push 成功；服务可通过 Prisma Client 读写审核数据\n\n## 任务 2：新增指纹工具（去重）\n- [ ] 文件：\n  - src/common/utils/fingerprint.util.ts（新增）\n- 描述：实现 `fingerprint(file, line|oldLine, commentText)` → sha256；提供稳定化 hash（去掉空白与无关符号）。\n- 成功标准：单元测试覆盖典型输入（同义文本/空白差异）产生相同指纹；导出函数可复用。\n- _Prompt：\n  Implement the task for spec ai-code-review-market-alignment, first run spec-workflow-guide to get the workflow guide then implement the task:\n  Role: Node.js 工具函数作者\n  Task: 在 src/common/utils/fingerprint.util.ts 中实现稳定哈希与导出方法\n  Restrictions: 不引入重量级依赖；优先使用 Node crypto；中文注释；提供最小单测样例\n  _Leverage: Node crypto；现有 utils 目录风格；设计文档 3 节\n  _Requirements: FR-3 去重与上限；NFR-2 可靠性\n  Success: 单测通过；被处理器与回写服务可调用\n\n## 任务 3：处理器标准化与去重/阈值控制\n- [ ] 文件：\n  - src/modules/queue/processors/analysis.processor.ts\n- 描述：在消费 job 时，统一 AI 返回为 `ReviewResult`；计算指纹、应用 `maxComments` 上限与去重；记录 costMs。\n- 成功标准：当 comments > 上限时仅保留 Top-N（可按 level/长度/置信度排序，先简单按出现顺序）；去重后 comments 无重复。\n- _Prompt：\n  Implement the task for spec ai-code-review-market-alignment, first run spec-workflow-guide to get the workflow guide then implement the task:\n  Role: 队列处理器开发\n  Task: 标准化 AI 返回、指纹计算、去重与上限裁剪并填充 ReviewResult 字段\n  Restrictions: 不改变现有队列名称与错误处理；记录必要日志不含敏感内容\n  _Leverage: ai/ai.service.ts，fingerprint.util.ts，Bull 队列现有实现\n  _Requirements: FR-2, FR-3, NFR-1\n  Success: 处理器能在无外部副作用下产生稳定 ReviewResult\n\n## 任务 4：幂等回写到 GitLab（讨论/行内评论）\n- [ ] 文件：\n  - src/gitlab/services/mr-discussion.service.ts（若无则新增）\n- 描述：发布摘要与行内评论；在评论末尾或元数据中附带 `[ML-FP:<fingerprint>]`，再次回写时检测已有指纹并跳过重复。\n- 成功标准：重复调用不产生重复评论；摘要评论单条更新或追加而非刷屏。\n- _Prompt：\n  Implement the task for spec ai-code-review-market-alignment, first run spec-workflow-guide to get the workflow guide then implement the task:\n  Role: GitLab API 适配工程师\n  Task: 实现带指纹标记的幂等回写（摘要/行内评论）\n  Restrictions: 不记录源码；遵循 GITLAB_WEBHOOK_SECRET 校验结果后的流程；错误重试由队列负责\n  _Leverage: gitlab/services/merge-request.service.ts, gitlab/services/mr-discussion.service.ts（新增）, @gitbeaker/rest/现有客户端\n  _Requirements: FR-4 回写与幂等；NFR-1 安全\n  Success: 同一条建议不重复出现；摘要仅一条保持更新\n\n## 任务 5：保存审查结果到数据库\n- [ ] 文件：\n  - src/services/analysis-result.service.ts（或 review.service.ts）\n- 描述：将 ReviewResult 写入 `Review` 与 `ReviewItem`；记录 provider、model、counts 与时间。\n- 成功标准：完成后可通过查询接口检索到本次审查数据。\n- _Prompt：\n  Implement the task for spec ai-code-review-market-alignment, first run spec-workflow-guide to get the workflow guide then implement the task:\n  Role: Prisma 服务实现者\n  Task: 新增保存方法 saveReviewResult(projectId, mrIid, result)\n  Restrictions: 事务写入；避免重复插入相同指纹（可 unique 或先查再写）\n  _Leverage: PrismaService；Review/ReviewItem 模型\n  _Requirements: FR-2, FR-5\n  Success: 返回 saved review id；数据结构完整\n\n## 任务 6：历史查询与详情接口\n- [ ] 文件：\n  - src/review/review.controller.ts\n  - src/review/review.service.ts\n- 描述：实现 `GET /api/reviews`（分页/过滤）与 `GET /api/reviews/:id`（详情）。\n- 成功标准：能按 projectId+mrIid 查询到列表；可按 level/category 过滤；详情含 comments。\n- _Prompt：\n  Implement the task for spec ai-code-review-market-alignment, first run spec-workflow-guide to get the workflow guide then implement the task:\n  Role: API 控制器开发\n  Task: 按设计文档实现查询接口，遵循统一分页/错误返回\n  Restrictions: 不暴露敏感字段；遵循全局 ValidationPipe 约束\n  _Leverage: 现有 Controller/Service 模板；Prisma 查询\n  _Requirements: FR-5；NFR-3\n  Success: Swagger 可试用；200 返回结构与设计一致\n\n## 任务 7：项目级配置接口（扩展字段）\n- [ ] 文件：\n  - src/ai/ai.controller.ts 或新增 src/projects/controllers/project-config.controller.ts\n  - src/projects/services/project-configuration.service.ts\n- 描述：补齐/校验 `provider/model/temperature/maxComments/dedupe/trigger` 字段的读写；记录审计日志。\n- 成功标准：前端表单可读写；保存后即时生效。\n- _Prompt：\n  Implement the task for spec ai-code-review-market-alignment, first run spec-workflow-guide to get the workflow guide then implement the task:\n  Role: 配置中心接口开发\n  Task: 在项目配置接口中支持 AI 相关字段的读写与校验\n  Restrictions: 不改变已有字段语义；向后兼容\n  _Leverage: projects 模块与现有配置实体；ConfigService\n  _Requirements: FR-6；NFR-3\n  Success: Swagger 中可读写配置；处理边界值与校验错误\n\n## 任务 8：指标埋点（Prometheus）\n- [ ] 文件：\n  - src/common/services/metrics.service.ts\n  - src/ai/ai.service.ts\n  - src/modules/queue/processors/analysis.processor.ts\n- 描述：新增/使用 histogram 与 counter 指标（调用时长、回写条数、队列失败数）；错误标注 status label。\n- 成功标准：`/metrics` 输出包含新增指标；数值随调用变化。\n- _Prompt：\n  Implement the task for spec ai-code-review-market-alignment, first run spec-workflow-guide to get the workflow guide then implement the task:\n  Role: 可观测性工程师\n  Task: 在 AI 调用、处理器与回写路径加入指标埋点\n  Restrictions: 无敏感信息；标签维度控制在少量关键项\n  _Leverage: prom-client；MetricsService；设计文档 7 节\n  _Requirements: FR-8；NFR-3\n  Success: curl /metrics 可见所需指标，并随调用递增\n\n## 任务 9：单元测试与最小 E2E（可选）\n- [ ] 文件：\n  - src/common/utils/__tests__/fingerprint.util.spec.ts（新增）\n  - src/review/review.controller.spec.ts（补充）\n- 描述：覆盖指纹工具与查询接口最小用例。\n- 成功标准：`npm test` 通过；关键路径覆盖。\n- _Prompt：\n  Implement the task for spec ai-code-review-market-alignment, first run spec-workflow-guide to get the workflow guide then implement the task:\n  Role: 测试工程师\n  Task: 为关键工具与接口补充单测\n  Restrictions: 不引入额外测试框架；遵循现有 jest 配置\n  _Leverage: 现有测试样例；jest 配置\n  _Requirements: NFR-2, NFR-3\n  Success: 单测通过且覆盖关键分支\n",
  "fileStats": {
    "size": 8492,
    "lines": 139,
    "lastModified": "2025-09-26T06:34:58.627Z"
  },
  "comments": []
}