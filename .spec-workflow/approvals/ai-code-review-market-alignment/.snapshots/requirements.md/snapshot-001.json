{
  "id": "snapshot_1758867345577_i23f6ix2z",
  "approvalId": "approval_1758867345559_ri8faqh6x",
  "approvalTitle": "Requirements: ai-code-review-market-alignment",
  "version": 1,
  "timestamp": "2025-09-26T06:15:45.577Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# 规格名称：ai-code-review-market-alignment（AI 代码审查市场对标落地）\n\n## 1. 背景与目标\n- 背景：结合业界代表产品（GitHub Copilot PR、CodeRabbit）与传统 SAST（SonarQube/Codacy），对齐用户对 AI 代码审查的关键期待；MoonLens 聚焦 GitLab 原生生态。\n- 目标：在“GitLab 原生 + 零持久化 + 可私有化”的前提下，交付“可用、可控、可观测”的 AI 审查能力，并为阶段二/三能力升级（对话式审查、图表与质量门禁、外部结果聚合）预留接口与数据模型。\n\n## 2. 范围与术语\n- 范围：后端服务（NestJS）能力与 API/数据契约（前端 UI 落地在相关规格中实现）；GitLab SaaS/自托管均适用。\n- 术语：\n  - MR：Merge Request；PR：Pull Request（竞品语境）\n  - 审查建议：AI 生成的逐行评论或摘要性建议\n  - 质量门禁：结合静态分析/策略的合并阻断阈值（可选）\n\n## 3. 用户画像与用户故事（EARS）\n- 当开发者提交/更新 MR 时，系统应在可配置阈值与去重策略下，生成“MR 摘要 + 逐行建议”，并以 GitLab 讨论与行内评论形式呈现。\n- 当 Reviewer 查看 MR 时，系统应支持按 projectId+mrIid 查询历史审查记录与聚合摘要，以便快速定位风险与趋势。\n- 当 Maintainer 配置项目时，系统应允许设置 Provider/模型/温度/评论上限/去重策略/触发条件（标签/变更规模），并可随时暂停/恢复。\n- 当外部工具（Sonar/Codacy）结果可用时，系统应允许在不上传源码的前提下聚合其结果，统一输出到同一 MR 维度接口供前端使用。\n- 当出现超时/配额/错误时，系统应按指数退避重试并暴露可观测指标，便于问题定位与成本控制。\n\n## 4. 功能性需求（FR）\n- FR-1 触发：支持 MR Create/Update/Comment 事件触发；可按标签/变更规模阈值过滤触发。\n- FR-2 内容：生成 MR 摘要（概要、风险、建议）与逐行建议（级别、类别、定位、文本）。\n- FR-3 去重与上限：同一建议不重复；每次最多 N 条（可配置）；超长建议折叠或转摘要链接。\n- FR-4 回写与幂等：将结果回写至 GitLab（讨论/行内评论）；保证幂等避免刷屏。\n- FR-5 查询：按 projectId + mrIid 查询历史记录与趋势摘要；支持分页与过滤（级别/类别/状态）。\n- FR-6 配置：组织/项目级 Provider/模型/参数/阈值/去重策略/触发条件；读写审计。\n- FR-7 聚合：预留 Sonar/Codacy 结果聚合接口与数据结构（阶段二对接）。\n- FR-8 可观测性：暴露队列长度、AI 调用时延/错误码、评论回写成功率、建议采纳率（占位，前端埋点对接）。\n\n## 5. 非功能性需求（NFR）\n- NFR-1 安全与隐私：不持久化源码；密钥/令牌加密；日志脱敏；不向第三方上传源码。\n- NFR-2 性能与可靠性：平均审查时延可配置（默认 60~120s 超时）；失败重试 + 死信；写入幂等。\n- NFR-3 可用性：Swagger/OpenAPI 完整；错误码一致；功能开关与降级策略清晰。\n- NFR-4 可扩展性：Provider 抽象与路由；静态分析聚合器抽象；对话式审查独立能力域。\n\n## 6. 约束与假设\n- 需要 GitLab Webhook 校验（X-Gitlab-Token）与最小权限令牌；\n- Provider 通过可配置 BASE_URL + KEY 接入，支持代理/私有模型网关；\n- RAG、图表与门禁在后续规格细化，本规格仅做数据契约与接口预留。\n\n## 7. 验收标准（AC）\n- AC-1 在 demo 项目中，提交 MR 后 2 分钟内出现摘要与 ≥1 条行内建议；重复提交相同变更不刷屏。\n- AC-2 通过 API 可按 projectId+mrIid 查询最新与历史记录，字段完整（级别/类别/定位/文本/时间）。\n- AC-3 配置变更（模型/阈值/去重策略）即时生效并有审计记录；暂停后不再触发新审查。\n- AC-4 指标端点/日志可见调用耗时与错误码分布；队列长度在压力下可观测。\n\n## 8. 依赖与风险\n- 依赖 GitLab API 与 Provider SLA/配额；依赖数据库与队列可用性；\n- 风险：建议质量波动（提示词/模板需迭代）；误报与过审；评论过多造成噪音。\n\n## 9. 里程碑\n- M1：MVP 能力巩固 + 接口/数据契约预留（本规格）。\n- M2：对话式审查、静态分析聚合、图表与质量门禁、指标与成本控制深化（独立规格推进）。\n",
  "fileStats": {
    "size": 4462,
    "lines": 55,
    "lastModified": "2025-09-26T06:15:33.532Z"
  },
  "comments": []
}