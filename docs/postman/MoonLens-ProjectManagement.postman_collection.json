{
  "info": {
    "name": "MoonLens Project Management",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "version": "1.0.0"
  },
  "item": [
    {
      "name": "Auth - Login",
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" } ],
        "url": { "raw": "{{baseUrl}}/auth/login", "host": [ "{{baseUrl}}" ], "path": [ "auth", "login" ] },
        "body": { "mode": "raw", "raw": "{\n  \"email\": \"{{adminEmail}}\",\n  \"password\": \"{{adminPassword}}\"\n}" }
      },
      "response": [],
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "const data = pm.response.json();",
              "pm.collectionVariables.set('token', data.accessToken || data.access_token || '');"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "GitLab - Create Connection",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Authorization", "value": "Bearer {{token}}" }
        ],
        "url": { "raw": "{{baseUrl}}/gitlab/connections", "host": ["{{baseUrl}}"], "path": ["gitlab", "connections"] },
        "body": { "mode": "raw", "raw": "{\n  \"name\": \"my-gitlab\",\n  \"host\": \"{{gitlabHost}}\",\n  \"authType\": \"PAT\",\n  \"token\": \"{{gitlabToken}}\"\n}" }
      }
    },
    {
      "name": "GitLab - Test Connection",
      "request": {
        "method": "GET",
        "header": [ { "key": "Authorization", "value": "Bearer {{token}}" } ],
        "url": { "raw": "{{baseUrl}}/gitlab/connections/{{connectionId}}/test", "host": ["{{baseUrl}}"], "path": ["gitlab","connections","{{connectionId}}","test"] }
      }
    },
    {
      "name": "GitLab - Sync Projects",
      "request": {
        "method": "POST",
        "header": [ { "key": "Authorization", "value": "Bearer {{token}}" } ],
        "url": { "raw": "{{baseUrl}}/gitlab/connections/{{connectionId}}/sync-projects", "host": ["{{baseUrl}}"], "path": ["gitlab","connections","{{connectionId}}","sync-projects"] }
      }
    },
    {
      "name": "Projects - Create Local Project",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Authorization", "value": "Bearer {{token}}" }
        ],
        "url": { "raw": "{{baseUrl}}/projects", "host": ["{{baseUrl}}"], "path": ["projects"] },
        "body": { "mode": "raw", "raw": "{\n  \"name\": \"Sample Project\",\n  \"description\": \"from postman\",\n  \"gitlabProjectId\": \"{{projectGitlabId}}\",\n  \"gitlabProjectUrl\": \"{{gitlabProjectUrl}}\",\n  \"defaultBranch\": \"main\"\n}" }
      }
    },
    {
      "name": "Projects - Link Connection in Config",
      "request": {
        "method": "PUT",
        "header": [ { "key": "Content-Type", "value": "application/json" }, { "key": "Authorization", "value": "Bearer {{token}}" } ],
        "url": { "raw": "{{baseUrl}}/projects/{{localProjectId}}/config", "host": ["{{baseUrl}}"], "path": ["projects","{{localProjectId}}","config"] },
        "body": { "mode": "raw", "raw": "{\n  \"association\": { \"connectionId\": \"{{connectionId}}\" }\n}" }
      }
    },
    {
      "name": "GitLab - Sync Members",
      "request": {
        "method": "POST",
        "header": [ { "key": "Authorization", "value": "Bearer {{token}}" } ],
        "url": { "raw": "{{baseUrl}}/gitlab/connections/{{connectionId}}/projects/{{projectGitlabId}}/sync-members", "host": ["{{baseUrl}}"], "path": ["gitlab","connections","{{connectionId}}","projects","{{projectGitlabId}}","sync-members"] }
      }
    },
    {
      "name": "GitLab - Sync Branches",
      "request": {
        "method": "POST",
        "header": [ { "key": "Authorization", "value": "Bearer {{token}}" } ],
        "url": { "raw": "{{baseUrl}}/gitlab/connections/{{connectionId}}/projects/{{projectGitlabId}}/sync-branches", "host": ["{{baseUrl}}"], "path": ["gitlab","connections","{{connectionId}}","projects","{{projectGitlabId}}","sync-branches"] }
      }
    },
    {
      "name": "GitLab - Upsert Webhook (optional)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" }, { "key": "Authorization", "value": "Bearer {{token}}" } ],
        "url": { "raw": "{{baseUrl}}/gitlab/connections/{{connectionId}}/projects/{{projectGitlabId}}/hooks", "host": ["{{baseUrl}}"], "path": ["gitlab","connections","{{connectionId}}","projects","{{projectGitlabId}}","hooks"] },
        "body": { "mode": "raw", "raw": "{\n  \"callbackUrl\": \"{{publicBaseUrl}}/api/webhooks/gitlab\",\n  \"secret\": \"{{webhookSecret}}\"\n}" }
      }
    }
  ]
}

