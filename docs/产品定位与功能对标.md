# MoonLens 产品定位与功能对标（后端视角）

目标与范围
- 后端负责鉴权与授权、GitLab 集成适配、Webhook 校验与事件入队、审查任务调度与结果回写、配置与阈值控制、审计与可观测性。

市场对标（摘要）
- GitHub Copilot（PR）：强在 GitHub 生态与生成式能力，不服务 GitLab 用户。
- CodeRabbit：支持 GitLab，具备摘要/逐行/对话等；强调安全与临时处理。
- SonarQube / Codacy：规则/质量门禁与指标体系成熟，深度集成 GitLab，逐步引入 AI。

MoonLens 的差异化
- GitLab 原生优先：Webhook 事件、MR 讨论 API、行内评论与摘要同步策略。
- AI Provider 抽象：支持 OpenAI/Anthropic/Azure/代理；可按组织/项目级配置路由与超时/重试策略。
- 零持久化与最小权限：diff 仅作临时处理；建议与摘要归档最小化；敏感配置加密存储。
- 与静态分析互补：聚合外部工具结果（计划），形成统一审查输出并提供质量门禁阈值。

功能基线（后端）
- 审查任务：
  - 入队：基于 GitLab Webhook（MR Create/Update/Comment）生成任务，去重与节流控制。
  - 执行：AI 服务 RPC/HTTP 调用，指数退避重试；失败入死信队列并告警。
  - 回写：MR 摘要与行内评论（含级别/类别/定位）。
- 鉴权与安全：
  - JWT + RBAC + 细粒度权限；项目级令牌加密；Webhook Secret 校验。
  - 审计与指标：记录任务生命周期、外部调用时延、错误类型与占比。
- 配置中心：
  - 组织/项目级模型与参数；阈值（每次最多评论 N 条、去重策略、阈值触发条件）。

路线图（与前端配合）
- 阶段二：
  - 对话式审查：监听评论事件，维护对话状态与上下文封装；引用片段精细定位。
  - 指标与门禁：与静态分析结果聚合，按阈值决定是否允许合并（可选、人审优先）。
- 阶段三：
  - 自动化修复建议：建议以 Patch 形式输出；引入“建议采纳率”与“回滚率”指标。
  - 模型路由与成本控制：根据上下文与历史质量路由不同模型，限额控制与配额告警。

落地接口（示例）
- POST `/webhooks/gitlab`：事件接收与校验 → 入队。
- POST `/api/reviews`：手动触发审查（调试/回溯场景）。
- GET `/api/reviews?projectId&mrIid`：历史审查记录与趋势。
- POST `/api/config`：组织/项目级 AI 设置（模型/温度/阈值/去重）。

运维与合规
- 配置与密钥：KMS/Secrets 管理；不入镜像/不落代码库。
- 数据最小化：不持久化源码片段；日志脱敏；必要时开启字段级加密。
- 可观测性：任务队列长度、AI 调用时延与错误码、评论回写成功率；暴露 Prometheus 指标。

KPI（衡量价值）
- 建议采纳率、误报率、平均审查时延、MR 合并前阻断次数（按阈值配置）、团队留存与使用频率。

