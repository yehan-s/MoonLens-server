import { Injectable } from '@nestjs/common';
import { AIReviewResult, CodeIssue } from './ai-review.service';

@Injectable()
export class CommentFormatterService {
  /**
   * æ ¼å¼åŒ– MR çº§åˆ«çš„æ€»è¯„è¯„è®ºï¼ˆCodeRabbit é£æ ¼ï¼‰
   */
  formatSummaryComment(reviewResult: AIReviewResult): string {
    const { summary, issues, score, metrics, suggestions } = reviewResult;
    
    // ç»Ÿè®¡ä¸åŒä¸¥é‡ç¨‹åº¦çš„é—®é¢˜
    const issueStats = this.categorizeIssues(issues);
    
    // é€‰æ‹©æ€»ä½“è¯„ä¼°çš„ emoji
    const severityEmoji = this.getSeverityEmoji(summary.severity);
    
    // ç”Ÿæˆ Markdown æ ¼å¼çš„è¯„è®º
    const markdown = `## ğŸ¤– AI Code Review

### ğŸ“Š Review Score: ${score}/100

**Overall Assessment**: ${severityEmoji} ${summary.description}

### ğŸ“ˆ Quality Metrics
- ğŸ”’ Security: ${metrics.security}/100
- âš¡ Performance: ${metrics.performance}/100
- ğŸ› ï¸ Maintainability: ${metrics.maintainability}/100
- ğŸ¯ Reliability: ${metrics.reliability}/100

### âš ï¸ Issues Found
- ğŸ”´ Error: ${issueStats.error} issues
- ğŸŸ¡ Warning: ${issueStats.warning} issues
- ğŸ”µ Info: ${issueStats.info} issues

${this.formatIssuesList(issues)}

${suggestions && suggestions.length > 0 ? this.formatSuggestions(suggestions) : ''}

---
*ğŸš€ Generated by MoonLens AI Review*
`;

    return markdown;
  }

  /**
   * æ ¼å¼åŒ–å•ä¸ªå†…è”è¯„è®º
   */
  formatInlineComment(issue: CodeIssue): string {
  const severityEmoji = this.getIssueSeverityEmoji(issue.severity);
  const typeLabel = this.getIssueTypeLabel(issue.type);

  // æ³¨æ„ï¼šå¿…é¡»ä½¿ç”¨çœŸå®æ¢è¡Œï¼ˆ\nï¼‰ï¼Œå¦åˆ™ GitLab ä¸ä¼šè¯†åˆ« suggestion ä»£ç å—
  let markdown = `**${severityEmoji} ${typeLabel}**: ${issue.title}\n\n`;
  markdown += `${issue.description}\n\n`;

  if (issue.suggestion) {
    markdown += `**\ud83d\udca1 Suggestion**: ${issue.suggestion}\n\n`;
  }

  // å¦‚æœæä¾›äº†å¯ç›´æ¥åº”ç”¨çš„ä»£ç æ›¿æ¢ï¼Œä¸Šç½‘ GitLab suggestion å—ä»¥æ”¯æŒâ€œApply suggestionâ€
  // GitLab è¦æ±‚ MR diff å†…è®¨è®º + ```suggestion ... ``` æ‰ä¼šå‘ˆç°æŒ‰é’®
  if (issue.codeExample?.after) {
    markdown += `\n\nã€ä»£ç å»ºè®®å¯ç›´æ¥åº”ç”¨ã€‘\n`;
    markdown += "```suggestion\n" + issue.codeExample.after + "\n```\n";
  } else if (issue.code) {
    // å‘ä¸‹å…¼å®¹ï¼šæ²¡æœ‰ after æ—¶ï¼Œä»å°è¯•ç”¨ suggestion åŒ…è£¹ç°æœ‰ä»£ç ï¼Œä¾¿äºä¸€é”®åº”ç”¨åå†å¾®è°ƒ
    markdown += "```suggestion\n" + issue.code + "\n```\n";
  }

  return markdown;
}

  /**
   * æ ¼å¼åŒ– issues åˆ—è¡¨ï¼ˆç”¨äºæ€»è¯„ä¸­ï¼‰
   */
  private formatIssuesList(issues: CodeIssue[]): string {
    if (!issues || issues.length === 0) {
      return '### âœ… No Issues Found\n\nGreat job! The code looks clean.\n';
    }

    let markdown = '### ğŸ“‹ Detailed Issues\n\n';
    
    // æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç»„
    const grouped = {
      error: issues.filter(i => i.severity === 'error'),
      warning: issues.filter(i => i.severity === 'warning'),
      info: issues.filter(i => i.severity === 'info'),
    };

    // è¾“å‡ºæ¯ä¸ªåˆ†ç»„
    for (const [severity, severityIssues] of Object.entries(grouped)) {
      if (severityIssues.length === 0) continue;
      
      const emoji = this.getIssueSeverityEmoji(severity as any);
      markdown += `#### ${emoji} ${severity.toUpperCase()}\n\n`;
      
      severityIssues.forEach((issue, index) => {
        const typeLabel = this.getIssueTypeLabel(issue.type);
        markdown += `${index + 1}. **${typeLabel}** in \`${issue.file}:${issue.line}\`\n`;
        markdown += `   - ${issue.title}\n`;
        if (issue.suggestion) {
          markdown += `   - ğŸ’¡ ${issue.suggestion}\n`;
        }
        markdown += '\n';
      });
    }

    return markdown;
  }

  /**
   * æ ¼å¼åŒ–å»ºè®®åˆ—è¡¨
   */
  private formatSuggestions(suggestions: string[]): string {
    let markdown = '### ğŸ’¡ Key Suggestions\n\n';
    suggestions.forEach((suggestion, index) => {
      markdown += `${index + 1}. ${suggestion}\n`;
    });
    return markdown + '\n';
  }

  /**
   * ç»Ÿè®¡ä¸åŒä¸¥é‡ç¨‹åº¦çš„é—®é¢˜æ•°é‡
   */
  private categorizeIssues(issues: CodeIssue[]): {
    error: number;
    warning: number;
    info: number;
  } {
    return {
      error: issues.filter(i => i.severity === 'error').length,
      warning: issues.filter(i => i.severity === 'warning').length,
      info: issues.filter(i => i.severity === 'info').length,
    };
  }

  /**
   * è·å–æ€»ä½“ä¸¥é‡ç¨‹åº¦çš„ emoji
   */
  private getSeverityEmoji(severity: 'success' | 'warning' | 'error' | 'info'): string {
    const emojiMap = {
      success: 'âœ…',
      warning: 'âš ï¸',
      error: 'ğŸ”´',
      info: 'â„¹ï¸',
    };
    return emojiMap[severity] || 'â„¹ï¸';
  }

  /**
   * è·å–é—®é¢˜ä¸¥é‡ç¨‹åº¦çš„ emoji
   */
  private getIssueSeverityEmoji(severity: 'error' | 'warning' | 'info'): string {
    const emojiMap = {
      error: 'ğŸ”´',
      warning: 'ğŸŸ¡',
      info: 'ğŸ”µ',
    };
    return emojiMap[severity] || 'ğŸ”µ';
  }

  /**
   * è·å–é—®é¢˜ç±»å‹çš„æ ‡ç­¾
   */
  private getIssueTypeLabel(type: string): string {
    const labelMap = {
      security: 'ğŸ” Security',
      performance: 'âš¡ Performance',
      quality: 'âœ¨ Code Quality',
      style: 'ğŸ¨ Style',
      bug: 'ğŸ› Bug',
    };
    return labelMap[type] || type;
  }
}
